const e=(t,i=[])=>{"string"==typeof t&&(t=parseInt(t.replaceAll("_","")));let l=127&t;return 0==(t>>>=7)?(i.push(l),i):(i.push(128|l),e(t,i))};function t(e,t=[]){for("string"==typeof e&&(e=parseInt(e.replaceAll("_","")));;){const i=Number(127&e);if(0==(e>>=7)&&0==(64&i)||-1===e&&0!=(64&i)){t.push(i);break}t.push(128|i)}return t}function i(e,t=[]){for("string"==typeof e&&(e="-"===(e=e.replaceAll("_",""))[0]?-BigInt(e.slice(1)):BigInt(e),n.setBigInt64(0,e),e=n.getBigInt64(0));;){const i=Number(0x7Fn&e);if(0n===(e>>=7n)&&0==(64&i)||-1n===e&&0!=(64&i)){t.push(i);break}t.push(128|i)}return t}const l=e=>"nan"===e||"+nan"===e||"-nan"===e?NaN:"inf"===e||"+inf"===e?1/0:"-inf"===e?-1/0:parseFloat(e.replaceAll("_","")),n=new DataView(new BigInt64Array(1).buffer);function r(e,t,i){return~(i=e.indexOf("nan:"))?(t=parseInt(e.slice(i+4)),t|=2139095040,"-"===e[0]&&(t|=2147483648),n.setInt32(0,t)):(t="string"==typeof e?l(e):e,n.setFloat32(0,t)),[n.getUint8(3),n.getUint8(2),n.getUint8(1),n.getUint8(0)]}const s=0x8000000000000000n,o=0x7ff0000000000000n;function f(e,t,i){return~(i=e.indexOf("nan:"))?(t=BigInt(e.slice(i+4)),t|=o,"-"===e[0]&&(t|=s),n.setBigInt64(0,t)):(t="string"==typeof e?l(e):e,n.setFloat64(0,t)),[n.getUint8(7),n.getUint8(6),n.getUint8(5),n.getUint8(4),n.getUint8(3),n.getUint8(2),n.getUint8(1),n.getUint8(0)]}const u=["unreachable","nop","block","loop","if","else",,,,,,"end","br","br_if","br_table","return","call","call_indirect",,,,,,,,,"drop","select",,,,,"local.get","local.set","local.tee","global.get","global.set",,,,"i32.load","i64.load","f32.load","f64.load","i32.load8_s","i32.load8_u","i32.load16_s","i32.load16_u","i64.load8_s","i64.load8_u","i64.load16_s","i64.load16_u","i64.load32_s","i64.load32_u","i32.store","i64.store","f32.store","f64.store","i32.store8","i32.store16","i64.store8","i64.store16","i64.store32","memory.size","memory.grow","i32.const","i64.const","f32.const","f64.const","i32.eqz","i32.eq","i32.ne","i32.lt_s","i32.lt_u","i32.gt_s","i32.gt_u","i32.le_s","i32.le_u","i32.ge_s","i32.ge_u","i64.eqz","i64.eq","i64.ne","i64.lt_s","i64.lt_u","i64.gt_s","i64.gt_u","i64.le_s","i64.le_u","i64.ge_s","i64.ge_u","f32.eq","f32.ne","f32.lt","f32.gt","f32.le","f32.ge","f64.eq","f64.ne","f64.lt","f64.gt","f64.le","f64.ge","i32.clz","i32.ctz","i32.popcnt","i32.add","i32.sub","i32.mul","i32.div_s","i32.div_u","i32.rem_s","i32.rem_u","i32.and","i32.or","i32.xor","i32.shl","i32.shr_s","i32.shr_u","i32.rotl","i32.rotr","i64.clz","i64.ctz","i64.popcnt","i64.add","i64.sub","i64.mul","i64.div_s","i64.div_u","i64.rem_s","i64.rem_u","i64.and","i64.or","i64.xor","i64.shl","i64.shr_s","i64.shr_u","i64.rotl","i64.rotr","f32.abs","f32.neg","f32.ceil","f32.floor","f32.trunc","f32.nearest","f32.sqrt","f32.add","f32.sub","f32.mul","f32.div","f32.min","f32.max","f32.copysign","f64.abs","f64.neg","f64.ceil","f64.floor","f64.trunc","f64.nearest","f64.sqrt","f64.add","f64.sub","f64.mul","f64.div","f64.min","f64.max","f64.copysign","i32.wrap_i64","i32.trunc_f32_s","i32.trunc_f32_u","i32.trunc_f64_s","i32.trunc_f64_u","i64.extend_i32_s","i64.extend_i32_u","i64.trunc_f32_s","i64.trunc_f32_u","i64.trunc_f64_s","i64.trunc_f64_u","f32.convert_i32_s","f32.convert_i32_u","f32.convert_i64_s","f32.convert_i64_u","f32.demote_f64","f64.convert_i32_s","f64.convert_i32_u","f64.convert_i64_s","f64.convert_i64_u","f64.promote_f32","i32.reinterpret_f32","i64.reinterpret_f64","f32.reinterpret_i32","f64.reinterpret_i64"],a={type:1,import:2,func:3,table:4,memory:5,global:6,export:7,start:8,elem:9,code:10,data:11},p={i32:127,i64:126,f32:125,f64:124,void:64,func:96,funcref:112},h={func:0,table:1,memory:2,global:3},c={"i32.load":4,"i64.load":8,"f32.load":4,"f64.load":8,"i32.load8_s":1,"i32.load8_u":1,"i32.load16_s":2,"i32.load16_u":2,"i64.load8_s":1,"i64.load8_u":1,"i64.load16_s":2,"i64.load16_u":2,"i64.load32_s":4,"i64.load32_u":4,"i32.store":4,"i64.store":8,"f32.store":4,"f64.store":8,"i32.store8":1,"i32.store16":2,"i64.store8":1,"i64.store16":2,"i64.store32":4};u.map(((e,t)=>u[e]=t));var g=e=>{let t=0,i=[],l="";const n=()=>l&&(i.push(l),l=""),r=()=>{for(let s,o;t<e.length;)if(s=e.charCodeAt(t),34===s)n(),l=e.slice(t++,t=e.indexOf('"',t)+1),n();else if(40===s)59===e.charCodeAt(t+1)?t=e.indexOf(";)",t)+2:(n(),t++,(o=i).push(i=[]),r(),i=o);else if(59===s)t=e.indexOf("\n",t)+1;else if(s<=32)n(),t++;else{if(41===s)return n(),t++;l+=e[t++]}n()};return r(),i.length>1?i:i[0]};const _={loop:1,block:1,if:1,end:-1,return:-1};var d=t=>{"string"==typeof t&&(t=g(t));let i={type:[],import:[],func:[],table:[],memory:[],global:[],export:[],start:[],elem:[],code:[],data:[]},l=[0,97,115,109,1,0,0,0];"string"==typeof t[0]&&"module"!==t[0]&&(t=[t]),t=t.map((e=>{if("import"===e[2]?.[0]){let[t,i,l,...n]=e;return[...l,[t,i,...n]]}if("import"===e[1]?.[0]){let[t,i,...l]=e;return[...i,[t,...l]]}return e}));let n=["type","import","table","memory","global","func","export","start","elem","data"],r=[];for(let e of n){let l=[];for(let n of t)n[0]===e?r.push(m[e](n,i)):l.push(n);t=l}for(let e of r)e&&e.call&&e();for(let t in i){let n=i[t];if(n.importc&&(n=n.slice(n.importc)),!n.length)continue;let r=a[t],s=[];8!==r&&s.push(n.length);for(let e of n)s.push(...e);l.push(r,...e(s.length),...s)}return new Uint8Array(l)};const m={type([,t,i],l){"$"!==t[0]&&(i=t,t=null);let n,r,s=[],o=[],[f,...u]=i;if("func"===f){for(;"param"===u[0]?.[0];){let[,...e]=u.shift();"$"===e[0]?.[0]&&(s[e.shift()]=s.length),s.push(...e.map((e=>p[e])))}"result"===u[0]?.[0]&&(o=u.shift().slice(1).map((e=>p[e]))),r=[p.func,...e(s.length),...s,...e(o.length),...o],n=l.type.findIndex((e=>e.every(((e,t)=>e===r[t])))),n<0&&(n=l.type.push(r)-1)}return t&&(l.type[t]=n),[n,s,o]},func([,...l],n){let s=[],o=[];"$"===l[0]?.[0]&&(n.func[l.shift()]=n.func.length),"export"===l[0]?.[0]&&m.export([...l.shift(),["func",n.func.length]],n);let[a,h,g]=m.type([,["func",...l]],n);for(;"param"===l[0]?.[0]||"result"===l[0]?.[0];)l.shift();for(n.func.push([a]);"local"===l[0]?.[0];){let e,[,...t]=l.shift();"$"===t[0][0]&&(h[e=t.shift()]?v("Ambiguous name "+e):s[e]=h.length+s.length),s.push(...t.map((e=>p[e])))}let d=s.reduce(((e,t)=>(t==e[e.length-1]?e[e.length-2]++:e.push(1,t),e)),[]);const y=l=>{let a,[g,..._]=l,d=u[g],m=0,x=[],$=[];if(d>=69)m=d>=167||d<=159&&d>=153||d<=145&&d>=139||d<=123&&d>=121||d<=105&&d>=103||80==d||69==d?1:2;else if(d>=40&&d<=62){let t,i={align:c[g],offset:0};for(;_[0]?.includes("=");)t=_.shift().split("="),i[t[0]]=Number(t[1]);$=[Math.log2(i.align),...e(i.offset)],m=d>=54?2:1}else if(d>=65&&d<=68)$=(65==d?t:66==d?i:67==d?r:f)(_.shift());else if(d>=32&&d<=34)$=e("$"===_[0]?.[0]?h[a=_.shift()]||s[a]:_.shift()),d>32&&(m=1);else if(35==d||36==d)$=e("$"===_[0]?.[0]?n.global[_.shift()]:_.shift()),d>35&&(m=1);else if(16==d){let t=_.shift();$=e(a="$"===t[0]?n.func[t]??v("Unknown function `"+t+"`"):t),[,m]=n.type[n.func[a][0]]}else if(17==d){let t=_.shift()[1];[,m]=n.type[t="$"===t[0]?n.type[t]:t],m++,$=e(t),$.push(0)}else if(63==d||64==d)$=[0],m=1;else if(4==d){o.push(d);let e,[,t]="result"===_[0][0]?_.shift():[,"void"];$=[p[t]],m=0,x.push(...y(_.shift())),"then"===_[0]?.[0]?[,...e]=_.shift():e=_,$.push(...b(e)),o.pop(),o.push(u.else),"else"===_[0]?.[0]&&([,...e]=_.shift(),e.length&&$.push(u.else,...b(e))),o.pop(),$.push(u.end)}else if(26==d||15==d)m=_.length?1:0;else if(27==d)m=3;else if(2==d||3==d){o.push(d),"$"===_[0]?.[0]&&(o[_.shift()]=o.length);let[,e]="result"===_[0]?.[0]?_.shift():[,"void"];$=[p[e],...b(_)],l.inline||(o.pop(),$.push(u.end))}else if(11==d)o.pop();else if(12==d||13==d)$=e("$"===_[0]?.[0]?o.length-o[_.shift()]:_.shift()),m=13==d?1+(_.length>1):!!_.length;else if(14==d){for($=[];!Array.isArray(_[0]);)a=_.shift(),$.push(...e("$"===a[0][0]?o.length-o[a]:a));$.unshift(...e($.length-1)),m=1+(_.length>1)}else null==d&&v(`Unknown instruction \`${g}\``);for(_.length<m&&v(`Stack arguments are not supported at \`${g}\``);m--;)x.push(...y(_.shift()));return _.length&&v(`Too many arguments for \`${g}\`.`),[...x,d,...$]},b=e=>{let t=[];for(;e.length;){let i,l=e.shift();"string"==typeof l&&((i=_[l])?(l=[l],l.inline=!0,i>0&&"$"===e[0]?.[0]&&l.push(e.shift())):v(`Inline instruction \`${l}\` is not supported`)),l&&t.push(...y(l))}return t};return()=>{let t=b(l);n.code.push([...e(t.length+2+d.length),...e(d.length>>1),...d,...t,u.end])}},memory([,...e],t){"$"===e[0][0]&&(t.memory[e.shift()]=t.memory.length),"export"===e[0][0]&&m.export([...e.shift(),["memory",t.memory.length]],t),t.memory.push($(e))},global([,...e],t){let i="$"===e[0][0]&&e.shift();i&&(t.global[i]=t.global.length);let[l,n]=e,r="mut"===l[0]?1:0;t.global.push([p[r?l[1]:l],r,...y(n)])},table([,...e],t){let i="$"===e[0][0]&&e.shift();i&&(t.table[i]=t.table.length);let l=$(e);t.table.push([p[e.pop()],...l])},elem([,t,...i],l){l.elem.push([0,...y(t,l),...e(i.length),...i.flatMap((t=>e("$"===t[0]?l.func[t]:t)))])},export([,t,[i,l]],n){"$"===l[0]&&(l=n[i][l]),n.export.push([...x(t),h[i],...e(l)])},import([,t,i,l],n){let r,[s,...o]=l,f="$"===o[0]?.[0]&&o.shift();if("func"===s){f&&(n.func[f]=n.func.length);let[t]=m.type([,["func",...o]],n);n.func.push(r=e(t)),n.func.importc=(n.func.importc||0)+1}else if("memory"===s)f&&(n.memory[f]=n.memory.length),r=$(o);else{if("global"!==s)throw Error("Unimplemented "+s);{f&&(n.global[f]=n.global.length);let[e]=o,t="mut"===e[0]?1:0;r=[p[t?e[1]:e],t],n.global.push(r),n.global.importc=(n.global.importc||0)+1}}n.import.push([...x(t),...x(i),h[s],...r])},data([,e,...t],i){i.data.push([0,...y(e,i),...x(t.map((e=>'"'===e[0]?e.slice(1,-1):e)).join(""))])},start([,e],t){t.start.length||t.start.push(["$"===e[0]?t.func[e]:e])}},y=([e,l],n)=>"f"===e[0]?[u[e],...("3"===e[1]?r:f)(l),u.end]:[u[e],...("3"===e[1]?t:i)("$"===l[0]?n.global[l]:l),u.end],b={n:10,r:13,t:9,v:1},x=t=>{t='"'===t[0]?t.slice(1,-1):t;let i,l=[],n=0;for(;n<t.length;)i=t.charCodeAt(n++),l.push(92===i?b[t[n++]]||parseInt(t.slice(n-1,++n),16):i);return l.unshift(...e(l.length)),l},$=([t,i,l])=>isNaN(parseInt(i))?[0,...e(t)]:["shared"===l?3:1,...e(t),...e(i)],v=e=>{throw Error(e)};let A="",U="\n",I="",w=!1;function q(e,t={}){return"string"==typeof e&&(e=g(e)),({indent:A,newline:U,pad:I,comments:w}=t),U||="",I||="",A||="","string"==typeof e[0]?z(e):e.map((e=>z(e))).join(U)}const k=["param","local","global","result","export"];function z(e,t=0){if(!Array.isArray(e))return e+"";let i=e[0];for(let l=1;l<e.length;l++)Array.isArray(e[l])?(!k.includes(e[l][0])||Array.isArray(e[l-1])&&e[l][0]!==e[l-1][0]?(i+=U,e[l]&&(i+=A.repeat(t+1))):Array.isArray(e[l-1])||(i+=" "),i+=z(e[l],t+1)):(i+=" ",i+=e[l]);return`(${i})`}export{d as compile,d as default,g as parse,q as print};